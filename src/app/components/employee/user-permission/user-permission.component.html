<div class="container-fluid">
  <div class="row g-4">
    <!-- All Permissions -->
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm h-100">
        <div class="card-header card-form-header text-white">
          <h6 class="mb-0"><i class="bi bi-list-check me-2"></i>All Permissions</h6>
        </div>
        <div class="card-body">
          <input type="text" class="form-control mb-2" placeholder="Search permissions..." [(ngModel)]="permissionSearch" (ngModelChange)="onPermissionSearch($event)">
          <div class="overflow-auto" style="max-height: 70vh;">
            <div *ngFor="let group of filteredGroups; let groupIndex = index">
              <div class="group-header bg-light p-2 rounded mb-1 d-flex justify-content-between align-items-center" >
                <span class="fw-semibold text-secondary" (click)="toggleGroup(groupIndex)">{{ group[0] }}</span>
                <button type="button" class="btn btn-sm btn-outline-danger-600 ms-auto me-3" (click)="selectGroup(groupIndex)">
                  Select Group
                </button>
                <span class="text-muted small pointer" (click)="toggleGroup(groupIndex)">Toggle</span>
              </div>
              <div [ngClass]="{'d-none': !expandedGroups[groupIndex]}" class="mb-2 ms-3">
                <div *ngFor="let p of group[1]; let i = index" class="form-check permission-card bg-white p-2 rounded border mb-1 d-flex align-items-center justify-content-between">
                  <div>
                    <label class="form-check-label fw-semibold text-xs text-dark">{{ p.displayName }}</label>
                  </div>
                  <input class="form-check-input checkbox-custom" type="checkbox" [formControl]="getPermissionControl(groupIndex, i)" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Assign/Remove Buttons (center column) -->
    <div class="col-12 col-lg-2 d-flex flex-column align-items-center justify-content-center">
      <button type="button"
        class="btn btn-success btn-lg rounded-circle mb-3"
        style="width: 60px; height: 60px;"
        (click)="moveToAssigned()"
        title="Assign selected permissions to user">
        <i class="bi bi-arrow-right"></i>
      </button>
      <button type="button"
        class="btn btn-danger btn-lg rounded-circle"
        style="width: 60px; height: 60px;"
        (click)="moveToAvailable()"
        title="Remove selected permissions from user">
        <i class="bi bi-arrow-left"></i>
      </button>
      <!-- Info Note -->
  <small class="text-muted text-center mt-3 px-2">
    <i class="bi bi-info-circle me-1"></i>
    Note: Role-based permissions are not shown here as they cannot be changed.
  </small>
    </div>

    <!-- User Assigned Permissions -->
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0"><i class="bi bi-person-check me-2"></i>User Special Permissions </h6>
        </div>
        <div class="card-body ">
          <app-searchable-dropdown
            [placeholder]="'Search User'"
            [labelName]="'Select User'"
            [hideLabel]="true"
            [fetchDataFn]="getUsers"
            (itemSelected)="onUserSelected($event)"
            [selectedItem]="selectedUser"
          ></app-searchable-dropdown>
          <div class="overflow-auto mt-2" style="max-height: 70vh;">
            <!-- Modified: expose groupIndex and add Select Group button -->
            <div *ngFor="let group of filteredAssignedGroups; let groupIndex = index">
              <ng-container *ngIf="assignedPermissions[group[0]]?.length">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="group-header bg-light p-2 rounded mb-1 fw-semibold text-secondary">{{ group[0] }}</div>
                  <button type="button" class="btn btn-sm btn-outline-danger-600 ms-2 me-3" (click)="selectAssignedGroup(groupIndex)">
                    Select Group
                  </button>
                </div>
                <div class="ms-3">
                  <div *ngFor="let p of assignedPermissions[group[0]]" class="form-check user-permission-card bg-blue-50 p-2 rounded border mb-1 d-flex align-items-center justify-content-between">
                    <div>
                      <span class="form-check-label fw-semibold text-xs text-dark">{{ p.displayName }}{{p.isOverride? '' : ' (From Role)'}}</span>
                    </div>
                    <input type="checkbox"
                      class="form-check-input checkbox-custom"
                      [checked]="assignedPermissionSelection.has(group[0] + '-' + p.displayName)"
                      (change)="onAssignedPermissionToggle(group[0], p.displayName, $event)"
                      [disabled]="!p.isOverride"
                    />
                  </div>
                </div>
              </ng-container>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fixed Bottom Buttons -->
  <div class="fixed-bottom  py-3 px-4">
    <div class="d-flex justify-content-end gap-3">
      <button type="button" routerLink="/employee" class="btn btn-warning px-4 py-2 shadow">Cancel</button>
      <button type="button" class="btn btn-success px-4 py-2 shadow" (click)="savePermissions()">Save Permissions</button>
    </div>
  </div>
</div>
