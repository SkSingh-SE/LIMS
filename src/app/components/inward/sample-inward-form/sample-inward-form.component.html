<div class="m-2">
  <!-- Nav Tabs -->
  <ul class="nav nav-tabs nav-fill text-center mb-3 gap-2" id="formTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
        Customer & Company Info
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="sample-tab" data-bs-toggle="tab" data-bs-target="#sample" type="button" role="tab">
        Sample Details
      </button>
    </li>
    <li *ngIf="sampleId > 0" class="nav-item" role="presentation">
      <button class="nav-link" id="plan-tab" data-bs-toggle="tab" data-bs-target="#plan" type="button" role="tab">Plan</button>
    </li>
  </ul>

  <!-- removed global ngSubmit to avoid accidental nested submissions -->
  <form [formGroup]="sampleInwardForm" class="needs-validation" novalidate>
    <div class="tab-content" id="formTabsContent">
      <!-- TAB 1: CUSTOMER & COMPANY INFO -->
      <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
        <fieldset class="border rounded p-3 mb-3 position-relative">
          <legend
            class="w-auto px-2 fw-semibold theme-color"
            style="font-size: 1rem; position: absolute; top: -0.9em; left: 1em; background: white"
          >
            Customer Details
          </legend>

          <!-- Customer Dropdown -->
          <div class="row mb-3">
            <div class="col-md-6">
              <app-searchable-dropdown
                [placeholder]="'Search Customer'"
                [labelName]="'Select Customer'"
                [fetchDataFn]="getCustomers"
                (itemSelected)="onCustomerSelect($event)"
                [required]="true"
                [selectedItem]="sampleInwardForm.get('customerID')?.value"
              ></app-searchable-dropdown>
            </div>
          </div>

          <!-- Combined Card -->
          <div class="card border shadow-sm">
            <div class="card-body small">
              <!-- Customer Details Section -->
              <div class="mb-3">
                <div class="fw-semibold text-danger mb-2">Customer Details</div>
                <div class="row row-cols-1 row-cols-md-4 g-3">
                  <div>
                    <strong>Address:</strong>
                    {{ sampleInwardForm.get("address")?.value || "-" }}
                  </div>
                  <div>
                    <strong>PIN Code:</strong>
                    {{ sampleInwardForm.get("pinCode")?.value || "-" }}
                  </div>
                  <div>
                    <strong>Area:</strong>
                    {{ sampleInwardForm.get("area")?.value || "-" }}
                  </div>
                  <div>
                    <strong>City:</strong>
                    {{ sampleInwardForm.get("city")?.value || "-" }}
                  </div>
                  <div>
                    <strong>State:</strong>
                    {{ sampleInwardForm.get("state")?.value || "-" }}
                  </div>
                  <div>
                    <strong>Country:</strong>
                    {{ sampleInwardForm.get("country")?.value || "India" }}
                  </div>
                  <div>
                    <strong>GST No.:</strong>
                    {{ sampleInwardForm.get("gstNo")?.value || "-" }}
                  </div>
                </div>
              </div>

              <!-- Dispatch Mode Section
              <div>
                <div class="fw-semibold text-danger mb-2">Dispatch Mode</div>
                <div formGroupName="dispatchMode" class="d-flex flex-wrap gap-4">
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input" formControlName="email" id="dispatchEmail" />
                    <label class="form-check-label" for="dispatchEmail">Email</label>
                  </div>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input" formControlName="whatsapp" id="dispatchWhatsApp" />
                    <label class="form-check-label" for="dispatchWhatsApp">WhatsApp</label>
                  </div>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input" formControlName="courier" id="dispatchCourier" />
                    <label class="form-check-label" for="dispatchCourier">Courier</label>
                  </div>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input" formControlName="selfPick" id="dispatchSelfPick" />
                    <label class="form-check-label" for="dispatchSelfPick">Self Pickup</label>
                  </div>
                </div>
              </div> -->

              <!-- Dispatch Modes -->
              <div class="">
                <label class="form-label">
                  Dispatch Modes
                  <span class="text-danger">*</span>
                </label>
                <div class="d-flex flex-wrap gap-4">
                  <div class="form-check" *ngFor="let mode of dispatchModes; index as modeIndex">
                    <input
                      id="dispatchMode-{{ modeIndex }}"
                      type="checkbox"
                      class="form-check-input"
                      [value]="mode.id"
                      [checked]="isDispatchModeSelected(mode.id)"
                      (change)="onDispatchModeToggle($event)"
                      [disabled]="isViewMode"
                    />
                    <label for="dispatchMode-{{ modeIndex }}" class="form-check-label form-label">{{ mode.name }}</label>
                  </div>
                </div>
                <div *ngIf="dispatchModesArray.touched && dispatchModesArray.invalid" class="text-danger">
                  At least one Dispatch Mode is required.
                </div>
              </div>
            </div>
          </div>
        </fieldset>

        <div class="billing-note">
          <strong>Billing Note:</strong>
          All invoices will be generated as of 06:07 PM IST on Friday, July 25, 2025. Please ensure payment is cleared within 15 days from
          the invoice date to avoid late fees.
        </div>

        <fieldset class="border rounded p-3 mb-2 position-relative">
          <legend
            class="w-auto px-2 fw-semibold theme-color"
            style="font-size: 1rem; position: absolute; top: -0.9em; left: 1em; background: white"
          >
            Contacts
          </legend>
          <!-- Contact Info Table -->
          <div class="table-responsive" formArrayName="contacts">
            <table class="table table-compact">
              <thead class="table-light">
                <tr class="text-nowrap text-muted small text-center">
                  <th class="fw-medium">Select</th>
                  <th class="fw-medium">Contact Person</th>
                  <th class="fw-medium">Mobile Number</th>
                  <th class="fw-medium">Email ID</th>
                  <th class="fw-medium">Bill</th>
                  <th class="fw-medium">Report</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let contact of contactControls.controls; let i = index" [formGroupName]="i">
                  <td class="text-center">
                    <span class="form-check d-flex align-items-center justify-content-center">
                      <input type="checkbox" class="form-check-input mt-1" formControlName="selected" />
                    </span>
                  </td>
                  <td>
                    {{ contact.get("name")?.value || "-" }}
                  </td>
                  <td>
                    {{ contact.get("mobileNo")?.value || "-" }}
                  </td>
                  <td>
                    {{ contact.get("emailId")?.value || "-" }}
                  </td>
                  <td class="text-center">
                    <span class="form-check d-flex align-items-center justify-content-center">
                      <input type="checkbox" class="form-check-input mt-1" formControlName="sendBill" (change)="onSendBillChange(i)" />
                    </span>
                  </td>
                  <td class="text-center">
                    <span class="form-check d-flex align-items-center justify-content-center">
                      <input type="checkbox" class="form-check-input mt-1" formControlName="sendReport" (change)="onSendReportChange(i)" />
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </fieldset>

        <div class="row g-3 mb-3">
          <!-- Reporting To Card -->
          <div class="col-md-6">
            <div class="card border shadow-sm h-100">
              <div class="card-header fw-semibold bg-light">Reporting To</div>
              <div class="card-body small">
                <div formGroupName="reportingTo" class="mb-3">
                  <label class="form-label">
                    Customer Name
                    <span class="text-danger">*</span>
                  </label>
                  <select class="form-select" formControlName="contactPersonID" (change)="onAddressCustomerChange('reportingTo', $event)">
                    <option value="">Select Customer</option>
                    <option *ngFor="let cPerson of reportingToContactPerson" [value]="cPerson.contactID">{{ cPerson.name }}</option>
                  </select>
                </div>

                <!-- Show Details if Customer is selected -->
                <ng-container *ngIf="reportingTo">
                  <div class="row row-cols-1 row-cols-md-2 g-2">
                    <div>
                      <strong>Address:</strong>
                      {{ reportingTo.get("address")?.value }}
                    </div>
                    <div>
                      <strong>PIN Code:</strong>
                      {{ reportingTo.get("pinCode")?.value }}
                    </div>
                    <div>
                      <strong>Area:</strong>
                      {{ reportingTo.get("area")?.value }}
                    </div>
                    <div>
                      <strong>City:</strong>
                      {{ reportingTo.get("city")?.value }}
                    </div>
                    <div>
                      <strong>State:</strong>
                      {{ reportingTo.get("state")?.value }}
                    </div>
                    <div>
                      <strong>Country:</strong>
                      {{ reportingTo.get("country")?.value }}
                    </div>
                  </div>
                </ng-container>
              </div>
            </div>
          </div>

          <!-- Billing To Card -->
          <div class="col-md-6">
            <div class="card border shadow-sm h-100">
              <div class="card-header fw-semibold bg-light d-flex justify-content-between align-items-center">Billing To</div>
              <div class="card-body small">
                <div formGroupName="billingTo" class="mb-3">
                  <label class="form-label">
                    Customer Name
                    <span class="text-danger">*</span>
                  </label>
                  <select class="form-select" formControlName="contactPersonID" (change)="onAddressCustomerChange('billingTo', $event)">
                    <option value="">Select Customer</option>
                    <option *ngFor="let customer of billingToContactPerson" [value]="customer.contactID">{{ customer.name }}</option>
                  </select>
                </div>

                <!-- Show Details if Customer is selected -->
                <ng-container *ngIf="billingTo">
                  <div class="row row-cols-1 row-cols-md-2 g-2">
                    <div>
                      <strong>Address:</strong>
                      {{ billingTo.get("address")?.value }}
                    </div>
                    <div>
                      <strong>PIN Code:</strong>
                      {{ billingTo.get("pinCode")?.value }}
                    </div>
                    <div>
                      <strong>Area:</strong>
                      {{ billingTo.get("area")?.value }}
                    </div>
                    <div>
                      <strong>City:</strong>
                      {{ billingTo.get("city")?.value }}
                    </div>
                    <div>
                      <strong>State:</strong>
                      {{ billingTo.get("state")?.value }}
                    </div>
                    <div>
                      <strong>Country:</strong>
                      {{ billingTo.get("country")?.value }}
                    </div>
                  </div>
                </ng-container>
              </div>
            </div>
          </div>
        </div>

        <fieldset class="border rounded p-3 mb-4 position-relative">
          <legend
            class="w-auto px-2 fw-semibold theme-color"
            style="font-size: 1rem; position: absolute; top: -0.9em; left: 1em; background: white"
          >
            Payment Info
          </legend>
          <div class="row row-cols-1 row-cols-md-4 mb-3">
            <div>
              <label class="form-label">Advance Payment</label>
              <div class="input-group">
                <input type="number" class="form-control" formControlName="advancePayment" placeholder="Enter amount" />
                <span class="input-group-text">Rs</span>
              </div>
            </div>
            <div>
              <label class="form-label">PO Number</label>
              <input type="number" class="form-control" formControlName="poNumber" placeholder="Enter PO Number" />
            </div>
            <div>
              <label class="form-label d-block">Bill Required</label>
              <div class="form-check form-check-inline">
                <input class="form-check-input mt-1" type="radio" id="billRequiredYes" formControlName="billRequired" [value]="true" />
                <label class="form-label" for="billRequiredYes">Yes</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input mt-1" type="radio" id="billRequiredNo" formControlName="billRequired" [value]="false" />
                <label class="form-label" for="billRequiredNo">No</label>
              </div>
            </div>
            <div>
              <label class="form-label d-block">Advance PI Required</label>
              <div class="form-check form-check-inline">
                <input
                  class="form-check-input mt-1"
                  type="radio"
                  id="advancePIRequiredYes"
                  formControlName="advancePIRequired"
                  [value]="true"
                />
                <label class="form-label" for="advancePIRequiredYes">Yes</label>
              </div>
              <div class="form-check form-check-inline">
                <input
                  class="form-check-input mt-1"
                  type="radio"
                  id="advancePIRequiredNo"
                  formControlName="advancePIRequired"
                  [value]="false"
                />
                <label class="form-label" for="advancePIRequiredNo">No</label>
              </div>
            </div>
            <div class="d-flex align-items-center">
              <div class="form-check">
                <input
                  class="form-check-input mt-1"
                  type="checkbox"
                  id="holdTestingUntilPIApproved"
                  formControlName="holdTestingUntilPIApproved"
                />
                <label class="form-label" for="holdTestingUntilPIApproved">Hold Testing Until PI approved</label>
              </div>
            </div>
          </div>
        </fieldset>
        <fieldset class="border rounded p-3 mb-4 position-relative">
          <legend
            class="w-auto px-2 fw-semibold theme-color"
            style="font-size: 1rem; position: absolute; top: -0.9em; left: 1em; background: white"
          >
            Document
          </legend>
          <div class="col-6, col-md-3">
            <label class="form-label">Upload Company Letter or Request Letter</label>
            <div class="">
              <ng-container *ngIf="sampleInwardForm.get('requestFilePath')?.value; else uploadField">
                <div class="d-flex align-items-center justify-content-between bg-light border p-1 rounded">
                  <span
                    class="text-truncate me-2"
                    type="button"
                    (click)="openFileInNewTab(sampleInwardForm.get('requestFilePath')?.value)"
                    title="{{ sampleInwardForm.get('requestFileName')?.value }}"
                  >
                    <i class="bi bi-file-earmark-fill"></i>
                    {{ sampleInwardForm.get("requestFileName")?.value }}
                  </span>
                  <button *ngIf="!isViewMode" type="button" class="btn btn-sm btn-link text-danger p-0" (click)="removeAttachment()">
                    <i class="bi bi-trash-fill fs-6 me-1"></i>
                  </button>
                </div>
              </ng-container>

              <ng-template #uploadField>
                <input
                  class="form-control form-control-sm input-file"
                  type="file"
                  accept=".pdf,.jpg,.jpeg,.png"
                  [disabled]="isViewMode"
                  (change)="onFileUpload($event)"
                />
              </ng-template>
              <!-- <input type="file" class="form-control form-control-sm w-auto" (change)="onFileUpload($event)" />
              <button type="button" class="btn btn-outline-danger btn-sm" (click)="removeAttachment()"><i class="bi bi-trash"></i></button> -->
            </div>
          </div>
        </fieldset>

        <!-- Add Go To Sample Details button -->
        <div class="d-flex justify-content-end mt-3">
          <button type="button" class="btn btn-outline-danger-600" (click)="goToSampleTab()">Sample Details</button>
        </div>
      </div>

      <!-- TAB 2: SAMPLE DETAILS -->
      <div class="tab-pane fade" id="sample" role="tabpanel" aria-labelledby="sample-tab">
        <fieldset formArrayName="sampleDetails" class="border rounded p-3 mb-3 position-relative">
          <legend
            class="w-auto px-2 fw-semibold theme-color"
            style="font-size: 1rem; position: absolute; top: -0.9em; left: 1em; background: white"
          >
            Sample Details
          </legend>

          <div class="table-responsive">
            <table class="table table-compact">
              <thead class="table-light">
                <tr class="text-nowrap text-muted small">
                  <th class="fw-medium text-center">Auto-Generated</th>
                  <th class="fw-medium text-center">Sample Description</th>
                  <th class="fw-medium text-center">Metal Classification</th>
                  <th class="fw-medium text-center">Product Condition</th>
                  <th class="fw-medium text-center">Remarks</th>
                  <th class="fw-medium text-center">Quantity</th>
                  <th class="fw-medium text-center">Image</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let sample of sampleDetails.controls; let i = index" [formGroupName]="i">
                  <td><input class="form-control form-control-sm" formControlName="sampleNo" readonly /></td>
                  <td><input class="form-control form-control-sm" formControlName="details" placeholder="Enter details" required /></td>
                  <td>
                    <app-searchable-dropdown
                      [placeholder]="'Search Metal Classification'"
                      [hideLabel]="true"
                      [fetchDataFn]="getMetalClassification"
                      (itemSelected)="onMetalClassificationSelected($event,i)"
                      [selectedItem]="sample.get('metalClassificationID')?.value"
                    ></app-searchable-dropdown>
                  </td>
                  <td>
                    <app-searchable-dropdown
                      [placeholder]="'Search Product Condition'"
                      [hideLabel]="true"
                      [fetchDataFn]="getProductConditions"
                      (itemSelected)="onProductConditionSelected($event,i)"
                      [selectedItem]="sample.get('productConditionID')?.value"
                    ></app-searchable-dropdown>
                  </td>
                  <td><input class="form-control form-control-sm" formControlName="remarks" placeholder="Remarks" /></td>
                  <td><input class="form-control form-control-sm" type="number" formControlName="quantity" min="1" /></td>
                  <td>
                    <ng-container *ngIf="sample.get('sampleFilePath')?.value; else uploadField">
                      <div class="d-flex align-items-center justify-content-between bg-light border p-1 rounded">
                        <span
                          class="text-truncate me-2"
                          type="button"
                          (click)="openFileInNewTab(sample.get('sampleFilePath')?.value)"
                          title="{{ sample.get('standardFile')?.value }}"
                        >
                          <i class="bi bi-file-earmark-fill"></i>
                          {{ sample.get("standardFile")?.value }}
                        </span>
                        <button *ngIf="!isViewMode" type="button" class="btn btn-sm btn-link text-danger p-0" (click)="removeSampleFile(i)">
                          <i class="bi bi-trash-fill fs-6 me-1"></i>
                        </button>
                      </div>
                    </ng-container>

                    <ng-template #uploadField>
                      <input
                        class="form-control form-control-sm input-file"
                        type="file"
                        accept=".jpg,.jpeg,.png"
                        [disabled]="isViewMode"
                        (change)="onUploadSampleImage(i, $event)"
                      />
                    </ng-template>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger-600" (click)="addSample()">
            <i class="bi bi-plus-circle-dotted"></i>
            Add Sample
          </button>
        </fieldset>
        <!-- SECTION 2: CASE DETAILS + IDENTIFICATION INFO -->
        <fieldset class="border rounded p-3 mb-3 position-relative">
          <legend
            class="w-auto px-2 fw-semibold theme-color"
            style="font-size: 1rem; position: absolute; top: -0.9em; left: 1em; background: white"
          >
            Case & Sample Identification
          </legend>

          <!-- Table -->
          <div class="table-responsive mb-2">
            <table class="table table-sm table-compact">
              <thead class="table-light">
                <tr class="text-nowrap text-muted small">
                  <th class="fw-medium text-center">Description</th>
                  <th *ngFor="let sample of sampleNumbers">
                    <span class="fw-medium text-center">{{ sample }}</span>
                  </th>
                  <th class="fw-medium text-center">Actions</th>
                </tr>
              </thead>
              <tbody formArrayName="sampleAdditionalDetails">
                <tr *ngFor="let row of sampleAdditionalDetails.controls; let rowIndex = index" [formGroupName]="rowIndex">
                  <td>
                    <select class="form-select form-select-sm" formControlName="label" (change)="onLabelChange()">
                      <option value="" disabled>Select Option</option>
                      <option *ngFor="let option of descriptionOptions" [value]="option" [disabled]="isOptionSelected(option, rowIndex)">
                        {{ option }}
                      </option>
                    </select>
                  </td>
                  <ng-container [formArrayName]="'values'">
                    <td *ngFor="let valueCtrl of getAdditionSampleRowValues(rowIndex)">
                      <input type="text" class="form-control form-control-sm" [formControl]="valueCtrl" placeholder="Enter Value" />
                    </td>
                  </ng-container>
                  <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" (click)="sampleAdditionalDetails.removeAt(rowIndex)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger-600" (click)="addAdditionalSampleRow()">
            <i class="bi bi-plus-circle-dotted"></i>
            Add Additional Info
          </button>
        </fieldset>

        <fieldset class="border rounded p-3 mb-2 position-relative">
          <legend
            class="w-auto px-2 fw-semibold theme-color"
            style="font-size: 1rem; position: absolute; top: -0.9em; left: 1em; background: white"
          >
            Additional Information
          </legend>

          <div class="row">
            <div class="col-4">
              <div class="">
                <label class="form-label">Sample Receipt Note</label>
                <textarea
                  class="form-control"
                  type="text"
                  placeholder="Enter Sample Receipt Note"
                  formControlName="sampleReceiptNote"
                  rows="3"
                ></textarea>
              </div>
            </div>
            <div class="col-8">
              <div class="d-flex flex-column gap-2">
                <div class="form-check">
                  <input type="checkbox" class="form-check-input mt-1" formControlName="urgent" id="urgent" />
                  <label class="form-check-label form-label" for="urgent">Urgent</label>
                </div>

                <div class="form-check">
                  <input type="checkbox" class="form-check-input mt-1" formControlName="returnSample" id="returnSample" />
                  <label class="form-check-label form-label" for="returnSample">Return Sample</label>
                </div>

                <div class="form-check">
                  <input type="checkbox" class="form-check-input mt-1" formControlName="notDestroyed" id="notDestroyed" />
                  <label class="form-check-label form-label" for="notDestroyed">Not to be Destroyed</label>
                </div>
              </div>
            </div>
          </div>
        </fieldset>
        <div *ngIf="!isViewMode" class="d-flex justify-content-end gap-2 mb-2">
          <button type="button" class="btn btn-warning" (click)="onCancel()">Cancel</button>
          <button type="button" class="btn btn-success px-3" (click)="onSubmit(false)" [disabled]="!sampleInwardForm.valid">Save</button>
        </div>
      </div>

      <!-- PLAN TAB TABLE FORMAT -->
      <div class="tab-pane fade show" id="plan" role="tabpanel">
        <app-plan-form [inwardID]="sampleId" [mode]="'review'"></app-plan-form>
      </div>

      <!-- removed global bottom save/cancel to keep actions scoped per tab -->
    </div>
  </form>
</div>
