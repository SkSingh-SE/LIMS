<div class="container-fluid pt-1" [formGroup]="planForm">
  <div class="card border shadow-sm mt-2 mb-2">
    <legend
      class="w-auto px-2 fw-semibold theme-color"
      style="font-size: 1rem; position: absolute; top: -0.9em; left: 1em; background: white"
    >
      Inward Details
    </legend>
    <div class="card-body small">
      <div class="row align-items-center d-flex justify-content-between">
        <div class="col-auto">
          <p class="mb-1">
            <strong>Case No:</strong>
            {{ planForm.get("caseNo")?.value || "-" }}
          </p>
        </div>
        <div class="col-auto">
          <p class="mb-1">
            <strong>Sample Receipt Note:</strong>
            {{ planForm.get("sampleReceiptNote")?.value || "-" }}
          </p>
        </div>
        <div class="col-auto">
          <p class="mb-1">
            <strong>Urgent:</strong>
            {{ planForm.get("urgent")?.value ? "Yes" : "No" }}
          </p>
        </div>
        <div class="col-auto">
          <p class="mb-1">
            <strong>Return Sample:</strong>
            {{ planForm.get("returnSample")?.value ? "Yes" : "No" }}
          </p>
        </div>
        <div class="col-auto">
          <p class="mb-1">
            <strong>Not Destroyed:</strong>
            {{ planForm.get("notDestroyed")?.value ? "Yes" : "No" }}
          </p>
        </div>
      </div>
      <div class="d-flex align-items-center gap-4 mt-2">
        <!-- Statement of Conformity -->
        <div class="d-flex align-items-center">
          <label class="form-label fw-semibold mb-0 me-2">Statement of Conformity:</label>
          <select class="form-select form-select-sm w-auto" formControlName="statementOfConformity">
            <option>Applicable</option>
            <option>Not Applicable</option>
          </select>
        </div>

        <!-- Decision Rule -->
        <div class="d-flex align-items-center">
          <label class="form-label fw-semibold mb-0 me-2">Decision Rule:</label>
          <select class="form-select form-select-sm w-auto" formControlName="decisionRule">
            <option>Without taking MOU into account</option>
            <option>With MOU consideration</option>
            <option>Not Applicable</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Samples Section -->
  <div formArrayName="samples">
    <div
      *ngFor="let sample of samples.controls; let sampleIdx = index"
      [formGroupName]="sampleIdx"
      class="border rounded p-3 mb-2 mt-3 position-relative"
    >
      <legend
        class="w-auto px-2 fw-semibold theme-color"
        style="font-size: 1rem; position: absolute; top: -0.9em; left: 1em; background: white"
      >
        Sample No: {{ sample.get("sampleNo")?.value }}
      </legend>

      <!-- Sample Details + Additional Details in one row -->
      <div class="card shadow-sm mb-3">
        <div class="card-body small">
          <div class="row">
            <!-- LEFT SIDE: Sample Details + Preparation -->
            <div class="col-md-10">
              <!-- Sample Details -->
              <div class="row g-3 mb-3 align-items-start">
                <!-- LEFT COLUMN (Auto-Adjusting Grid) -->
                <div class="col-12 col-md-6">
                  <div class="d-flex flex-wrap gap-3">
                    <!-- Details -->
                    <div class="flex-grow-1 flex-basis-45">
                      <p class="mb-1">
                        <strong>Details:</strong>
                        <span class="text-muted">{{ sample.get("details")?.value || "-" }}</span>
                      </p>
                    </div>

                    <!-- Remarks -->
                    <div class="flex-grow-1 flex-basis-45">
                      <p class="mb-1">
                        <strong>Remarks:</strong>
                        <span class="text-muted">{{ sample.get("remarks")?.value || "-" }}</span>
                      </p>
                    </div>

                    <!-- Quantity -->
                    <div class="flex-grow-1 flex-basis-45">
                      <p class="mb-1">
                        <strong>Quantity:</strong>
                        <span class="text-muted">{{ sample.get("quantity")?.value || "0" }}</span>
                      </p>
                    </div>

                    <!-- Dynamic Additional Details -->
                    <ng-container *ngFor="let row of getAdditionalDetailsArray(sample)">
                      <div class="flex-grow-1 flex-basis-45">
                        <p class="mb-1">
                          <strong>{{ row.get("label")?.value }}:</strong>
                          <span class="text-muted">{{ row.get("value")?.value || "-" }}</span>
                        </p>
                      </div>
                    </ng-container>
                  </div>
                </div>

                <!-- RIGHT COLUMN (Fixed 2 Dropdowns) -->
                <div class="col-12 col-md-6">
                  <div class="row g-2">
                    <!-- Metal Classification -->
                    <div class="col-12 col-md-6">
                      <app-searchable-dropdown
                        [placeholder]="'Search Metal Classification'"
                        [labelName]="'Metal Classification'"
                        [fetchDataFn]="getMetalDrop"
                        (itemSelected)="onMetalClassificationSelected($event, sampleIdx)"
                        [selectedItem]="sample.get('metalClassificationID')?.value"
                        [isDisabled]="isViewMode"
                      ></app-searchable-dropdown>
                    </div>

                    <!-- Product Condition -->
                    <div class="col-12 col-md-6">
                      <app-searchable-dropdown
                        [placeholder]="'Search Product Condition'"
                        [labelName]="'Product Condition'"
                        [fetchDataFn]="getProductConditionDrop"
                        (itemSelected)="onProductConditionSelected($event, sampleIdx)"
                        [selectedItem]="sample.get('productConditionID')?.value"
                        [isDisabled]="isViewMode"
                      ></app-searchable-dropdown>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Preparation Options -->
              <div class="row g-2 align-items-center">
                <!-- Cutting -->
                <div class="col-md-3">
                  <label class="form-label d-block">Sample Prepration Required</label>
                  <div class="form-check form-check-inline">
                    <input
                      type="radio"
                      class="form-check-input"
                      [value]="true"
                      formControlName="preparationRequired"
                      id="cuttingYes-{{ sampleIdx }}"
                    />
                    <label class="form-check-label" for="cuttingYes-{{ sampleIdx }}">Yes</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      type="radio"
                      class="form-check-input"
                      [value]="false"
                      formControlName="preparationRequired"
                      id="cuttingNo-{{ sampleIdx }}"
                    />
                    <label class="form-check-label" for="cuttingNo-{{ sampleIdx }}">No</label>
                  </div>
                </div>

                <!-- Machining -->
                <div class="col-md-3">
                  <label class="form-label d-block">Machining Required</label>
                  <div class="form-check form-check-inline">
                    <input
                      type="radio"
                      class="form-check-input"
                      [value]="true"
                      formControlName="machiningRequired"
                      id="machiningYes-{{ sampleIdx }}"
                    />
                    <label class="form-check-label" for="machiningYes-{{ sampleIdx }}">Yes</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      type="radio"
                      class="form-check-input"
                      [value]="false"
                      formControlName="machiningRequired"
                      id="machiningNo-{{ sampleIdx }}"
                    />
                    <label class="form-check-label" for="machiningNo-{{ sampleIdx }}">No</label>
                  </div>
                </div>

                <!-- Machining Amount -->
                <div class="col-md-3" *ngIf="sample.get('machiningRequired')?.value === true">
                  <label class="form-label">Machining Amount</label>
                  <input
                    type="number"
                    class="form-control"
                    formControlName="machiningAmount"
                    id="machiningAmount-{{ sampleIdx }}"
                    placeholder="Enter amount"
                  />
                </div>

                <!-- Specimen -->
                <div class="col-md-3" *ngIf="sample.get('machiningRequired')?.value === true">
                  <label class="form-label">Specimen</label>
                  <input
                    type="text"
                    class="form-control"
                    formControlName="specimen"
                    id="specimen-{{ sampleIdx }}"
                    placeholder="Enter specimen"
                  />
                </div>

                <!-- Other Preparation -->
                <div class="col-md-3">
                  <label class="form-label d-block">Other Preparation</label>
                  <div class="form-check form-check-inline">
                    <input
                      type="radio"
                      class="form-check-input"
                      [value]="true"
                      formControlName="otherPreparation"
                      id="otherYes-{{ sampleIdx }}"
                    />
                    <label class="form-check-label" for="otherYes-{{ sampleIdx }}">Yes</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input
                      type="radio"
                      class="form-check-input"
                      [value]="false"
                      formControlName="otherPreparation"
                      id="otherNo-{{ sampleIdx }}"
                    />
                    <label class="form-check-label" for="otherNo-{{ sampleIdx }}">No</label>
                  </div>
                </div>

                <!-- Other Charge -->
                <div class="col-md-3" *ngIf="sample.get('otherPreparation')?.value === true">
                  <label class="form-label">Other Preparation Charge</label>
                  <input
                    type="number"
                    class="form-control"
                    formControlName="otherPreparationCharge"
                    id="otherPreparationCharge-{{ sampleIdx }}"
                    placeholder="Enter charge"
                    min="0"
                  />
                </div>

                <!-- TPI -->
                <div class="col-md-3">
                  <label class="form-label d-block">TPI Required</label>
                  <div class="form-check form-check-inline">
                    <input type="radio" class="form-check-input" [value]="true" formControlName="tpiRequired" id="tpiYes-{{ sampleIdx }}" />
                    <label class="form-check-label" for="tpiYes-{{ sampleIdx }}">Yes</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input type="radio" class="form-check-input" [value]="false" formControlName="tpiRequired" id="tpiNo-{{ sampleIdx }}" />
                    <label class="form-check-label" for="tpiNo-{{ sampleIdx }}">No</label>
                  </div>
                </div>
                <!-- TPI Agency -->
                <div *ngIf="sample.get('tpiRequired')?.value === true" class="col-md-3">
                  <app-searchable-dropdown
                    class="col-md-3"
                    [placeholder]="'Search TPI Agency'"
                    [labelName]="'TPI Agency'"
                    [fetchDataFn]="getTPIAgencies"
                    (itemSelected)="onTPISelected($event, sampleIdx)"
                    [selectedItem]="sample.get('tpiAgencyID')?.value"
                    [isDisabled]="isViewMode || sample.get('tpiRequired')?.value === false"
                  ></app-searchable-dropdown>
                </div>

                <div class="col-md-3">
                  <label class="form-label fw-semibold">Test Instructions</label>
                  <textarea
                    class="form-control"
                    formControlName="testInstructions"
                    rows="2"
                    placeholder="Enter any special test instructions for this sample"
                  ></textarea>
                </div>
              </div>
            </div>

            <!-- RIGHT SIDE: Image Preview -->
            <div class="col-md-2 d-flex align-items-center justify-content-center">
              <div
                *ngIf="sample.get('sampleFilePath')?.value"
                class="preview-box w-100 h-100"
                (click)="openFileInNewTab(sample.get('sampleFilePath')?.value)"
                style="cursor: pointer"
              >
                <img
                  [src]="baseUrl + sample.get('sampleFilePath')?.value"
                  [alt]="sample.get('fileName')?.value"
                  class="img-fluid rounded border w-100 h-100"
                  style="object-fit: contain; min-height: 150px; min-width: 100px"
                />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Test Plans -->
      <div formArrayName="testPlans">
        <ng-container *ngIf="getTestPlansArray(sample).length > 0; else addPlanBlock">
          <div
            *ngFor="let testPlan of getTestPlansArray(sample); let planIdx = index"
            [formGroupName]="planIdx"
            class="mb-3 shadow-sm rounded p-3 position-relative"
          >
            <ul class="nav nav-tabs mb-3" role="tablist">
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  [ngClass]="{ active: isActiveTab(sampleIdx, planIdx, 'general') }"
                  (click)="setActiveTab(sampleIdx, planIdx, 'general')"
                  id="general-tab-{{ sampleIdx }}-{{ planIdx }}"
                  [attr.data-bs-toggle]="'tab'"
                  [attr.data-bs-target]="'#general-' + sampleIdx + '-' + planIdx"
                  type="button"
                  role="tab"
                >
                  General Test
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  [ngClass]="{ active: isActiveTab(sampleIdx, planIdx, 'chemical') }"
                  (click)="setActiveTab(sampleIdx, planIdx, 'chemical')"
                  id="chemical-tab-{{ sampleIdx }}-{{ planIdx }}"
                  [attr.data-bs-toggle]="'tab'"
                  [attr.data-bs-target]="'#chemical-' + sampleIdx + '-' + planIdx"
                  type="button"
                  role="tab"
                >
                  Chemical Test
                </button>
              </li>
            </ul>
            <div class="tab-content">
              <!-- General Test Tab -->
              <div
                class="tab-pane fade"
                id="general-{{ sampleIdx }}-{{ planIdx }}"
                role="tabpanel"
                [ngClass]="{ 'show active': isActiveTab(sampleIdx, planIdx, 'general') }"
              >
                <ng-container *ngIf="getTestArray(sampleIdx, planIdx, 'generalTests').length > 0">
                  <div [formGroup]="getGeneralTestSection(sampleIdx, planIdx)">
                    <div class="row row-cols-auto row-cols-md-2 mb-2">
                      <div class="">
                        <app-searchable-dropdown
                          [placeholder]="'Search Specification'"
                          [labelName]="'Specification'"
                          [fetchDataFn]="getMaterialSpecificationGradeForGeneralWrapper(sampleIdx)"
                          (itemSelected)="onSpecificationGradeSelected(sampleIdx, planIdx, $event, 'specification1', 'generalTests')"
                          [hideLabel]="false"
                          [required]="true"
                          [isDisabled]="isViewMode"
                          [selectedItem]="getGeneralTestSection(sampleIdx, planIdx).get('specification1')?.value"
                        ></app-searchable-dropdown>
                      </div>
                      <div class="">
                        <app-searchable-dropdown
                          [placeholder]="'Search Specification'"
                          [labelName]="'Specification 2'"
                          [fetchDataFn]="getMaterialSpecificationGradeForGeneralWrapper(sampleIdx)"
                          (itemSelected)="onSpecificationGradeSelected(sampleIdx, planIdx, $event, 'specification2', 'generalTests')"
                          [hideLabel]="false"
                          [isDisabled]="isViewMode"
                          [selectedItem]="getGeneralTestSection(sampleIdx, planIdx).get('specification2')?.value || null"
                        ></app-searchable-dropdown>
                      </div>
                    </div>
                    <div
                      *ngIf="getGeneralTestSection(sampleIdx, planIdx).errors?.['sameSpecification'] && (getGeneralTestSection(sampleIdx, planIdx).get('specification1')?.touched || getGeneralTestSection(sampleIdx, planIdx).get('specification2')?.touched)"
                      class="text-danger small mb-2"
                    >
                      Specification 1 and Specification 2 must be different.
                    </div>
                    <table class="table table-sm table-compact">
                      <thead class="table-light">
                        <tr class="text-nowrap text-muted small">
                          <th class="fw-medium text-center">Sr No.</th>
                          <th class="fw-medium text-center">Test Method Standard</th>
                          <th class="fw-medium text-center">Laboratory Test</th>
                          <th class="fw-medium text-center">Test Case </th>
                          <th class="fw-medium text-center">Quantity</th>
                          <th class="fw-medium text-center">
                            <div>Report No</div>
                            <div>ULR No/Cancel</div>
                          </th>
                          <th class="fw-medium text-center">Action</th>
                        </tr>
                      </thead>
                      <tbody
                        #dropdownContainer
                        class="dropdown-wrapper position-relative"
                        style="z-index: 1000"
                        formArrayName="methods"
                        *ngIf="getTestArray(sampleIdx, planIdx, 'generalTests').length > 0"
                      >
                        <tr
                          *ngFor="let method of getMethodRows(sampleIdx, planIdx).controls; let methodIdx = index"
                          [formGroupName]="methodIdx"
                        >
                          <td>{{ methodIdx + 1 }}</td>
                          <td>
                            <select class="form-select" formControlName="standardID" [disabled]="isViewMode">
                              <option value="">-- Select Standard --</option>
                              <option *ngFor="let standard of filteredStandardsMap[sampleIdx + '_' + planIdx] || []" [value]="standard.id">
                                {{ standard.name }}
                              </option>
                            </select>
                          </td>
                          <td>
                            <select
                              class="form-select"
                              formControlName="testMethodID"
                              [disabled]="isViewMode"
                              (change)="onLaboratorySelected({ id: $any($event.target).value }, sampleIdx, planIdx, methodIdx)"
                            >
                              <option value="">-- Select Laboratory Test --</option>
                              <option *ngFor="let test of filteredTestMethods[`${sampleIdx}_${planIdx}`]" [value]="test.id">
                                {{ test.name }}
                              </option>
                            </select>
                            <div *ngIf="method.get('testMethodID')?.hasError('required') && method.get('testMethodID')?.touched" class="text-danger small mt-1">
                              Required
                            </div>
                          </td>
                          <!-- Test Case Dropdown (Mandatory) -->
                          <td>
                            <select
                              class="form-select"
                              formControlName="testCaseID"
                              [disabled]="isViewMode || !method.get('testMethodID')?.value"
                              (change)="
                                onTestCaseSelected(
                                  { id: $any($event.target).value },
                                  sampleIdx,
                                  planIdx,
                                  methodIdx
                                )
                              "
                            >
                              <option value="">-- Select Test Case --</option>
                              <option *ngFor="let testCase of filteredTestCases[`${sampleIdx}_${planIdx}_${methodIdx}`] || []" [value]="testCase.id">
                                {{ testCase.name }}
                              </option>
                            </select>
                            <div *ngIf="method.get('testCaseID')?.hasError('required') && method.get('testCaseID')?.touched" class="text-danger small mt-1">
                              Test Case is required
                            </div>
                          </td>
                          <td>
                            <input
                              type="number"
                              class="form-control form-control-sm"
                              formControlName="quantity"
                              placeholder="Enter Quantity"
                            />
                          </td>
                          <td>
                            <div class="">
                              {{ method.get("reportNo")?.value }}
                            </div>
                            <div class="d-flex justify-content-center gap-2">
                              {{ method.get("ulrNo")?.value }}
                              <div class="form-check mt-0">
                                <input type="checkbox" class="form-check-input mt-1" formControlName="cancel" />
                              </div>
                            </div>
                          </td>
                          <td>
                            <div *ngIf="getTestArray(sampleIdx, planIdx, 'generalTests').length > 0 && !isViewMode">
                              <button
                                type="button"
                                class="btn btn-sm btn-outline-danger"
                                (click)="getMethodRows(sampleIdx, planIdx).removeAt(methodIdx)"
                              >
                                <i class="bi bi-trash"></i>
                              </button>
                            </div>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                    <button
                      *ngIf="!isViewMode"
                      type="button"
                      class="btn btn-sm btn-outline-danger-600"
                      (click)="addMethodRow(sampleIdx, planIdx)"
                    >
                      <i class="bi bi-plus-circle-dotted"></i>
                      Add Row
                    </button>
                  </div>
                </ng-container>
                <button
                  *ngIf="getTestArray(sampleIdx, planIdx, 'generalTests').length < 1 && !isViewMode"
                  type="button"
                  class="btn btn-sm btn-outline-danger-600 mt-2"
                  (click)="addTestBlock(sampleIdx, planIdx, 'generalTests')"
                >
                  <i class="bi bi-plus-circle-dotted"></i>
                  Add General Test
                </button>
              </div>
              <!-- Chemical Test Tab -->
              <div
                class="tab-pane fade"
                id="chemical-{{ sampleIdx }}-{{ planIdx }}"
                role="tabpanel"
                [ngClass]="{ 'show active': isActiveTab(sampleIdx, planIdx, 'chemical') }"
              >
                <div formArrayName="chemicalTests">
                  <ng-container *ngIf="getChemicalTestsArray(sampleIdx, planIdx).length > 0">
                    <div *ngFor="let chemTest of getChemicalTestsArray(sampleIdx, planIdx); let chemIdx = index" [formGroupName]="chemIdx">
                      <div class="p-3 border rounded mb-3">
                        <div class="d-flex justify-content-between">
                          <label class="form-label fw-semibold">Chemical Test - Sample No: {{ testPlan.get("sampleNo")?.value }}</label>
                          <label class="form-label fw-semibold">Report No: {{ chemTest.get("reportNo")?.value }}</label>
                          <label class="form-label fw-semibold">ULR: {{ chemTest.get("ulrNo")?.value }}</label>
                        </div>
                        <div formGroupName="testTypes" class="row my-2">
                          <div class="col-md-2" *ngFor="let test of testTypeList">
                            <div class="form-check">
                              <input
                                type="checkbox"
                                [formControlName]="test.id"
                                class="form-check-input mt-1"
                                id="{{ test.id }}-{{ sampleIdx }}-{{ planIdx }}-{{ chemIdx }}"
                              />
                              <label class="form-label" [for]="test.id + '-' + sampleIdx + '-' + planIdx + '-' + chemIdx">{{ test.name }}</label>
                            </div>
                          </div>
                        </div>
                        <div class="row mt-3">
                          <div class="col-md-3">
                            <app-searchable-dropdown
                              [placeholder]="'Search Specification'"
                              [labelName]="'Specification'"
                              [fetchDataFn]="getMaterialSpecificationGradeForChemicalWrapper(sampleIdx)"
                              (itemSelected)="onSpecificationGradeSelected(sampleIdx, planIdx, $event, 'specification1', 'chemicalTests')"
                              [hideLabel]="false"
                              [required]="true"
                              [isDisabled]="isViewMode"
                              [selectedItem]="chemTest.get('specification1')?.value"
                            ></app-searchable-dropdown>
                          </div>
                          <div class="col-md-3">
                            <app-searchable-dropdown
                              [placeholder]="'Search Specification'"
                              [labelName]="'Specification 2'"
                              [fetchDataFn]="getMaterialSpecificationGradeForChemicalWrapper(sampleIdx)"
                              (itemSelected)="onSpecificationGradeSelected(sampleIdx, planIdx, $event, 'specification2', 'chemicalTests')"
                              [hideLabel]="false"
                              [required]="false"
                              [isDisabled]="isViewMode"
                              [selectedItem]="chemTest.get('specification2')?.value"
                            ></app-searchable-dropdown>
                          </div>
                        </div>
                        <div
                          class="mt-3"
                          *ngIf="getElementsArray(sampleIdx, planIdx, chemIdx) && getElementsArray(sampleIdx, planIdx, chemIdx).length > 0"
                        >
                          <table class="table table-sm table-compact mt-2">
                            <thead class="table-light">
                              <tr class="text-nowrap text-muted small">
                                <th class="fw-medium text-center">Sr No.</th>
                                <th class="fw-medium text-center">Element</th>
                                <th class="fw-medium text-center">Min</th>
                                <th class="fw-medium text-center">Max</th>
                                <th class="fw-medium text-center">Unit</th>
                                <th class="fw-medium text-center">
                                  <input
                                    type="checkbox"
                                    [checked]="isAllElementsSelected(sampleIdx, planIdx, chemIdx)"
                                    (change)="toggleSelectAllElements($event, sampleIdx, planIdx, chemIdx)"
                                    [disabled]="isViewMode"
                                    aria-label="Select all elements"
                                  />
                                </th>
                                <!-- <th class="fw-medium text-center">Action</th> -->
                              </tr>
                            </thead>
                            <tbody formArrayName="elements">
                              <tr
                                *ngFor="let el of getElementsArray(sampleIdx, planIdx, chemIdx); let elIdx = index"
                                [formGroupName]="elIdx"
                              >
                                <td>{{ elIdx + 1 }}</td>
                                <td>
                                  <app-searchable-dropdown
                                    class="w-100"
                                    [placeholder]="'Search Parameter'"
                                    [labelName]="'Parameter'"
                                    [fetchDataFn]="getParameterDrop"
                                    (itemSelected)="onParameterSelected($event, sampleIdx, planIdx, chemIdx, elIdx)"
                                    [isDisabled]="true"
                                    [hideLabel]="true"
                                    [selectedItem]="el.get('parameterID')?.value"
                                  ></app-searchable-dropdown>
                                </td>
                                <td class="text-center">
                                  <input
                                    type="number"
                                    class="form-control form-control-sm text-center"
                                    formControlName="minValue"
                                    [readonly]="!el.get('minValue')?.value"
                                  />
                                </td>
                                <td class="text-center">
                                  <input
                                    type="number"
                                    class="form-control form-control-sm text-center"
                                    formControlName="maxValue"
                                    [readonly]="true"
                                  />
                                </td>
                                <td class="text-center">
                                  <span>{{ el.get("parameterUnit")?.value || "-" }}</span>
                                </td>
                                <td class="text-center">
                                  <div class="form-check d-flex align-items-center justify-content-center">
                                    <input type="checkbox" class="form-check-input" formControlName="selected" />
                                  </div>
                                </td>
                                <!-- <td>
                                  <button
                                    *ngIf="!isViewMode"
                                    type="button"
                                    class="btn btn-sm btn-outline-danger"
                                    (click)="removeElementRow(sampleIdx, planIdx, elIdx)"
                                  >
                                    <i class="bi bi-trash"></i>
                                  </button>
                                </td> -->
                              </tr>
                            </tbody>
                          </table>
                          <!-- <button
                            *ngIf="!isViewMode"
                            type="button"
                            class="btn btn-sm btn-outline-danger-600"
                            (click)="addElementRow(sampleIdx, planIdx)"
                          >
                            <i class="bi bi-plus-circle-dotted"></i>
                            Add Element
                          </button> -->
                        </div>
                      </div>
                    </div>
                  </ng-container>

                  <button
                    *ngIf="getTestArray(sampleIdx, planIdx, 'chemicalTests').length < 1 && !isViewMode"
                    type="button"
                    class="btn btn-sm btn-outline-danger-600"
                    (click)="addTestBlock(sampleIdx, planIdx, 'chemicalTests')"
                  >
                    <i class="bi bi-plus-circle-dotted"></i>
                    Add Chemical Test
                  </button>
                </div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #addPlanBlock>
          <button *ngIf="!isViewMode" type="button" class="btn btn-sm btn-outline-danger-600" (click)="addPlanToSample(sampleIdx)">
            <i class="bi bi-plus-circle-dotted"></i>
            Add Plan
          </button>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Plan-specific Save/Cancel -->
  <div *ngIf="!isViewMode" class="d-flex justify-content-end gap-2 mb-2">
    <button type="button" class="btn btn-warning" (click)="onCancel()">Cancel</button>
    <button type="button" class="btn btn-success px-3" (click)="onSave()" [disabled]="!planForm.valid">Save Plan</button>
    <button type="button" class="btn btn-info" (click)="onSendForReview()">Send for Review</button>
  </div>
</div>
